sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/core/syncStyleClass","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/core/library","sap/base/Log"],function(e,t,r,n,i,o,s,a,c){"use strict";function l(e,r){return new Promise(function(n,i){cadesplugin.async_spawn(function*(n){const i=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store");yield i.Open(cadesplugin.CAPICOM_CURRENT_USER_STORE,cadesplugin.CAPICOM_MY_STORE,cadesplugin.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED);const o=yield i.Certificates;const s=yield o.Find(cadesplugin.CAPICOM_CERTIFICATE_FIND_SHA1_HASH,e);const a=yield s.Count;if(a===0){const r="Certificate not found: "+e;t.error(r);n[1](r)}const c=yield s.Item(1);const l=yield cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner");yield l.propset_Certificate(c);const d=yield cadesplugin.CreateObjectAsync("CAdESCOM.SignedXML");yield d.propset_Content(r);let u="";try{u=yield d.Sign(l)}catch(e){const r=cadesplugin.getLastError(e);t.error("Failed to create signature. Error: "+r);n[1](r)}yield i.Close();return n[0](u)},n,i)})}function d(e){return new Promise(function(r,n){cadesplugin.async_spawn(function*(r){const n=yield cadesplugin.CreateObjectAsync("CAdESCOM.SignedXML");try{yield n.Verify(e)}catch(e){const n=cadesplugin.getLastError(e);t.error("Failed to verify signature. Error: "+n);return r[1](n)}return r[0]()},r,n)})}function u(){return new Promise(function(e,r){cadesplugin.async_spawn(function*(e){try{const t=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store");yield t.Open(cadesplugin.CAPICOM_CURRENT_USER_STORE,cadesplugin.CAPICOM_MY_STORE,cadesplugin.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED);const r=yield t.Certificates;const n=yield r.Count;const i=[];for(let e=1;e<=n;e++){const t=yield r.Item(e);i.push({SubjectName:yield t.SubjectName,Thumbprint:yield t.Thumbprint,ValidToDate:new Date(yield t.ValidToDate)})}e[0](i)}catch(r){const n=cadesplugin.getLastError(r);t.error("Failed to load certificates. Error: "+n);e[1](n)}},e,r)})}return e.extend("ui5.crypto.ui5cryptotest.controller.View1",{onInit:function(){},handleFileChange:async function(e){function t(e){return new Promise((t,r)=>{const n=new FileReader;n.readAsText(e);n.onload=()=>t(n.result);n.onerror=e=>r(e)})}const r=await t(e.getParameter("files")[0]);const n=await this._askForCertificate();const i=this.getView();i.setBusy(true);let o;try{o=await l(n,r)}catch(e){c.error(e)}i.setBusy(false);i.getModel().setProperty("/target",o)},_askForCertificate:async function(){const e=this.getView().getModel().getProperty("/cert");if(e)return e;const t=await this._loadCertSelectDialog();t.setBusy(true);t.open();t.getModel().setProperty("/certs",await u());t.setBusy(false);return await new Promise((e,t)=>{this.resolveAskForCertificatePromise=e;this.rejectAskForCertificatePromise=t})},_loadCertSelectDialog:function(){const e=this.getView();const t=e.byId("CertSelectDialog");return t?Promise.resolve(t):r.load({id:e.getId(),name:"ui5.crypto.ui5cryptotest.fragment.CertSelectDialog",controller:this}).then(t=>{e.addDependent(t);n("sapUiSizeCompact",e,t);return t})},onCertSearch:function(e){const t=e.getParameter("value");e.getParameter("itemsBinding").filter(new i([new i("SubjectName",o.Contains,t),new i("Thumbprint",o.Contains,t)],false),s.Application)},onCertSelectDialogConfirm:function(e){const t=e.getParameter("selectedItem").getBindingContext().getObject("Thumbprint");this.getView().getModel().setProperty("/cert",t);this.resolveAskForCertificatePromise(t)},onCertSelectDialogCancel:function(){const e="Certificate not selected";t.error(e);this.rejectAskForCertificatePromise(e)},handleVerify:async function(){const e=this.getView();let t;e.setBusy(true);d(e.getModel().getProperty("/target")).then(()=>t=true,()=>t=false).finally(()=>{e.setBusy(false);const r=t?a.ValueState.Success:a.ValueState.Error;e.getModel().setProperty("/state",r)})},handleDownload:function(){const e=this.getView().getModel().getProperty("/target");const t=document.createElement("a");t.href=`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`;t.download="signed.xml";t.click()}})});