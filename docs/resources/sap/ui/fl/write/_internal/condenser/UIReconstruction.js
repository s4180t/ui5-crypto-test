/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/write/_internal/condenser/classifications/Create","sap/ui/fl/write/_internal/condenser/classifications/Destroy","sap/ui/fl/write/_internal/condenser/classifications/Move","sap/ui/fl/write/_internal/condenser/Utils"],function(n,e,t,i,r,a,c){"use strict";var f={};var o={create:i,destroy:r,move:a};function u(n,t){e(n,function(n,i){e(i,function(e,r){t(i,n,r,e)})})}function s(n,e,t){n.splice(t,0,n.splice(e,1)[0])}function l(n,e){var t={};u(n,function(n,i,r,a){var f=r[c.TARGET_UI];f.forEach(function(n){e.forEach(function(e){if(n===e.affectedControl){if(!t[i]){t[i]={}}var r=t[i];if(!r[a]){r[a]=[]}var c=r[a];c.push(e)}})})});return t}function h(n){return!n.some(function(n){return n.classification!==t.Create})}function v(n){return!n.some(function(n){return c.isUnknown(n)})}function d(n){return n.getTargetIndex(n.change)}function E(n){n.sort(function(n,e){var t=d(n);var i=d(e);return t-i})}function g(n){return!n.some(function(n){return!c.isUnknown(n)})}function I(e,t){var i;if(e.length<t.length){i=t.slice(e.length);if(!g(i)){return false}t=t.slice(0,e.length)}else if(e.length>t.length){i=e.slice(t.length,e.length);if(!g(i)){return false}e=e.slice(0,t.length)}return n(e,t)}function T(n,e,t,i,r){var a={};r.forEach(function(n){var i=n.targetContainer;if(!a[i]){a[i]={}}var r=a[i];if(!r[e]){r[e]=c.initializeArrayWithPlaceholders(0,t.length-1)}o[n.classification].simulate(r[e],n,t)});var f=a[n][e];if(I(i,f)){return true}return false}function p(n,i){function r(n,e){var t=e.change.getState();e.setTargetIndex(e.change,n);e.change.setState(t)}function a(i,a,f){f[c.TARGET_UI].forEach(function(i,a){if(!c.isUnknown(i)){var f=n[i];var o=f[c.INDEX_RELEVANT];e(o,function(n,e){if(n!==t.Destroy){e.forEach(r.bind(this,a))}})}})}u(i,a)}function _(n,t){u(t,function(t,i,r,a){var f=r[c.INITIAL_UI];var o=r[c.TARGET_UI];if(I(f,o)){o.forEach(function(t){var i=n[t];if(i!==undefined){e(i[c.INDEX_RELEVANT],function(n,e){e.forEach(function(n){n.change.condenserState="delete"})});delete i[c.INDEX_RELEVANT]}});delete t[a]}})}function A(n,e){u(e,function(e,t,i){var r=i[c.INITIAL_UI];var a=i[c.TARGET_UI];r.forEach(function(e,t){var i=n[e];if(!i||!i[c.INDEX_RELEVANT]){var r=c.PLACEHOLDER+t;var f=a.indexOf(e);if(f>=0){a[f]=r}}})})}f.swapChanges=function(n,e){var t=n.map(function(n){return e.indexOf(n)}).sort();n.forEach(function(n){e[t.shift()]=n})};f.sortIndexRelatedChanges=function(n,e){var t=[];var i=l(n,e);u(i,function(e,i,r,a){var f=n[i][a][c.TARGET_UI];var o=n[i][a][c.INITIAL_UI];var u=true;if(v(f)||h(r)){E(r)}else if(!T(i,a,o,f,r)){u=false;var l=r.length;while(l!==0&&!u){var d=0;var g=1;while(g<r.length&&!u){s(r,d,g);u=T(i,a,o,f,r);d++;g++}l--}}if(!u){throw Error("no correct sorting found for the container: "+i)}t.push(r.map(function(n){return n.change}))});return t};f.addChange=function(n,e){return o[e.classification].addToReconstructionMap(n,e)};f.compareAndUpdate=function(n,e){_(n,e);A(n,e);p(n,e)};return f});