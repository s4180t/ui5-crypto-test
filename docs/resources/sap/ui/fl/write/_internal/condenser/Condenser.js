/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/UIChange","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/classifications/Update","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Utils","sap/ui/performance/Measurement","sap/base/util/restricted/_isEqual"],function(e,n,t,r,a,i,o,s,c,f,u,d,l,p,g,h,C,v){"use strict";var E={};var y="unclassified";var S={lastOneWins:u,reverse:d,update:l};var I=["affectedControl","sourceContainer","targetContainer","updateControl"];function _(e,n){var t=e[o.Move];return n.classification===o.Create&&t&&t[t.length-1].targetContainer===n.targetContainer}function m(e,n){return n.classification===o.Move&&e[o.Destroy]}function O(e,n){return n.classification===o.Create&&e[o.Destroy]}function b(e,n,t,r){if(!m(e,t)&&!O(e,t)){var a=t.classification;if(!e[a]){t.change=r;r.condenserState="select";e[a]=[t]}else{r.condenserState="delete"}e[a][0].updateChange=r}if(_(e,t)||O(e,t)){if(e[o.Move]){e[o.Move].forEach(function(e){e.change.condenserState="delete"});delete e[o.Move]}if(e[o.Destroy]){e[o.Destroy].forEach(function(e){e.change.condenserState="delete"});delete e[o.Destroy]}}return p.addChange(n,t)}function x(e,n,t){if(!e[n.classification]){e[n.classification]={}}var r=e[n.classification];S[n.classification].addToChangesMap(r,n,t);return Promise.resolve()}function N(e,n,t,r,a){if(!e[r.type]){e[r.type]={}}var i=e[r.type];if(r.type===g.NOT_INDEX_RELEVANT){return x(i,r,a)}t.push(a);return b(i,n,r,a)}function T(e,n,t){if(!e[n]){e[n]=[]}e[n].push(t);t.condenserState="select"}function A(e,n){var t=a.getControlIdBySelector(n.getSelector(),e);var r=i.byId(t);if(r){var o={modifier:a,appComponent:e,view:h.getViewForControl(r)};var c=s.getControlIfTemplateAffected(n,r,o);return Promise.resolve(s.getChangeHandler(n,c,o)).then(function(e){if(e&&typeof e.getCondenserInfo==="function"){return e.getCondenserInfo(n,o)}return undefined}).then(function(e){if(e&&c.bTemplateAffected){M(e,n)}return e}).catch(function(){return undefined})}return Promise.resolve()}function M(e,n){var t=n.getOriginalSelector();var r=n.getSelector();I.forEach(function(n){if(e[n]&&e[n]===r){e[n]=t}})}function D(e,n,t,r){var i=n!==undefined?n.affectedControl:a.getControlIdBySelector(t.getSelector(),r);if(!e[i]){e[i]={}}if(n&&n.updateControl){var o=n.updateControl;e[i]=Object.assign(e[i],e[o]);delete e[o]}return e[i]}function R(e,n,t,r,a){return a.reduce(function(a,i){return a.then(L.bind(this,e,n,t,r,i))}.bind(this),Promise.resolve())}function L(e,n,t,r,a){return A(e,a).then(function(i){U(i,e);var o=D(n,i,a,e);if(i!==undefined){w(i);return N(o,t,r,i,a).then(function(){if(i.update){P(o,i,a)}})}T(o,y,a);n[y]=true;return undefined})}function w(e){if(S[e.classification]){e.type=g.NOT_INDEX_RELEVANT}else{e.type=g.INDEX_RELEVANT}}function U(e,n){I.forEach(function(t){if(e&&e[t]){e[t]=a.getControlIdBySelector(e[t],n)}})}function P(e,n,r){var a=t.get([g.NOT_INDEX_RELEVANT,o.Update,n.uniqueKey],e);if(a){a.change.condenserState="delete";if(r.condenserState==="delete"){return}n.update(r,a.updateContent);if(r.getState()===f.LifecycleState.PERSISTED){r.condenserState="update"}}}function j(t,r){e(t,function(e,a){if(S[e]&&S[e].getChangesFromMap){S[e].getChangesFromMap(t,e).forEach(function(e){r.push(e)})}else if(n(a)){return j(a,r)}else if(Array.isArray(a)){a.forEach(function(e){if(e instanceof c){r.push(e)}else{r.push(e.change)}})}});return r}function V(e){return j(e,[])}function X(t,r){e(t,function(e,t){if(n(t)){X(t,r)}else if(Array.isArray(t)){t.forEach(function(e){if(!(e instanceof c)){r.push(e)}})}});return r}function B(e,n){n.sort(function(n,t){return e.indexOf(n)-e.indexOf(t)})}function F(e,n){n.sort(function(n,t){return e.indexOf(n.change)-e.indexOf(t.change)})}function W(e,n){var t=e.map(function(e){return e.getId()});n.forEach(function(n){if(t.indexOf(n.getId())===-1){e.push(n)}})}function q(e,n){e.forEach(function(e){var t=e.updateChange;if(t&&!v(t.getContent(),e.change.getContent())&&t.getState()!==f.LifecycleState.NEW){var r=e.change;if(t.getId()!==r.getId()){var a=r.getContent();t.setContent(a);r.condenserState="delete";n=n.map(function(e){if(e.getId()===r.getId()){return t}return e})}else{t.setState(f.LifecycleState.DIRTY)}t.condenserState="update"}});return n}E.condense=function(e,n){C.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var t={};var a={};var i=[];var o=[];var s=[];n.slice(0).reverse().forEach(function(e){if(e instanceof c&&e.isSuccessfullyApplied()){s.push(e)}else{o.push(e)}});C.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return R(e,t,a,i,s).then(function(){C.end("Condenser_defineMaps");var e=t[y];if(!e){p.compareAndUpdate(t,a)}var s=V(t);if(e){i.forEach(function(e){e.condenserState="select"});W(s,i)}s=s.concat(o);B(n,s);if(!e){C.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var c=true;var f=X(t,[]);F(n,f);var u;try{C.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);u=p.sortIndexRelatedChanges(a,f)}catch(e){r.error("Error during Condensing: "+e.message,"No Condensing performed for index-relevant changes.");c=false}C.end("Condenser_sort");if(c){s=q(f,s);B(n,s);u.forEach(function(e){p.swapChanges(e,s)})}else{i.forEach(function(e){e.condenserState="select"});W(s,i);B(n,s)}C.end("Condenser_handleIndexRelatedChanges")}C.end("Condenser_overall");return s})};return E});