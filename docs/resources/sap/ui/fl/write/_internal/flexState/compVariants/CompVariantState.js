/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/UriParameters","sap/ui/core/Core","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexObjects/CompVariant","sap/ui/fl/apply/_internal/flexObjects/CompVariantRevertData","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/RevertData","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexObjects/UpdatableChange","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantMerger","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions","sap/ui/fl/write/api/Version"],function(e,t,n,a,r,i,o,s,c,p,u,f,l,v,g,d,y,C){"use strict";function S(e,t){var n=h("/draftFilenames",t);if(n){return e.getState()===u.LifecycleState.NEW||n.includes(e.getId())}return true}function h(e,t){var t={reference:i.normalizeReference(t.reference),layer:t.layer};if(y.hasVersionsModel(t)){return y.getVersionsModel(t).getProperty(e)}return undefined}function V(e,t){var n=e.getFlexObjectMetadata?e.getFlexObjectMetadata().changeType:e.getChangeType();if(!["defaultVariant","updateVariant"].includes(n)){return false}var a=e.getLayer()===t.layer;var r=e.getFlexObjectMetadata().packageName;var i=!r||r==="$TMP";return a&&i&&S(e,t)}function m(e,t){if(t.isVariant&&t.isVariant()){return e.variants}var n=t.getChangeType();switch(n){case"defaultVariant":return e.defaultVariants;case"standardVariant":return e.standardVariants;default:return e.changes}}function x(e,t){for(var n=0;n<e.length;n++){if(e[n].fileName===t.fileName){e.splice(n,1,t);break}}}function O(e,t,n){return d.update({flexObject:e.convertToFileContent?e.convertToFileContent():e.getDefinition(),layer:e.getLayer(),transport:e.getRequest(),parentVersion:n}).then(function(t){if(t&&t.response){e.setResponse(t.response);if(n){y.onAllChangesSaved({reference:t.response.reference,layer:t.response.layer})}}else{e.setState(u.LifecycleState.PERSISTED)}}).then(function(){var n=m(t.changes.comp,e);var a=e.convertToFileContent?e.convertToFileContent():e.getDefinition();x(n,a);return a})}function T(e,t){for(var n=e.length-1;n>=0;n--){var a=e[n].fileName||e[n].getId()&&e[n].getId();if((a||e[n].getId())===t){e.splice(n,1);break}}}function b(e,t){delete t.byId[e.getId()];if(e.getChangeType()==="standardVariant"){t.standardVariantChange=undefined}else{T(m(t,e),e.getId())}}function D(e,t,n,a){var r=e.convertToFileContent?e.convertToFileContent():e.getDefinition();return d.remove({flexObject:r,layer:e.getLayer(),transport:e.getRequest(),parentVersion:a}).then(function(){b(e,t)}).then(function(){T(m(n.changes.comp,e),r.fileName);return r})}function I(e){var t={};if(typeof e.texts==="object"){Object.keys(e.texts).forEach(function(n){t[n]={value:e.texts[n],type:"XFLD"}})}return t}function E(e){return e&&[u.LifecycleState.NEW,u.LifecycleState.DIRTY,u.LifecycleState.DELETED].includes(e.getState())}function R(e){return e.variants.concat(e.changes).concat(e.defaultVariants).concat(e.standardVariantChange)}function F(e){if(e.layer){return e.layer}if(e.isUserDependent){return r.USER}var t=n.fromQuery(window.location.search).get("sap-ui-layer")||"";t=t.toUpperCase();if(t){return t}if(!e.fileType==="variant"){return r.CUSTOMER}var a=g.getInstanceOrUndef().isPublicLayerAvailable();return a?r.PUBLIC:r.CUSTOMER}function U(e){var t=l.getCompVariantsMap(e.reference)._getOrCreate(e.persistencyKey);return t.byId[e.id]}function N(e){if(e instanceof o){e.removeAllRevertData()}}function L(e,t){e.storeExecuteOnSelection(t.executeOnSelection);e.storeFavorite(t.favorite);e.storeContexts(t.contexts);e.storeName(t.name);e.storeContent(t.content||e.getContent());return e}function j(e,t){e.setExecuteOnSelection(t.executeOnSelection);e.setFavorite(t.favorite);e.setContexts(t.contexts);e.setName(t.name);e.setContent(t.content||e.getContent());return e}var M={};M.setDefault=function(e){var t={defaultVariantName:e.defaultVariantId};e.layer=e.layer||n.fromQuery(window.location.search).get("sap-ui-layer")||r.USER;var o=l.getCompVariantsMap(e.reference)._getOrCreate(e.persistencyKey);var s="defaultVariant";var u=o.defaultVariants;var v=u[u.length-1];if(!v||!V(v,e)){var g={fileName:i.createDefaultFileName(s),fileType:"change",changeType:s,layer:e.layer,content:t,namespace:i.createNamespace(e,"changes"),reference:e.reference,selector:{persistencyKey:e.persistencyKey},support:e.support||{}};g.support.generator=g.support.generator||"CompVariantState."+s;g.support.sapui5Version=a.getConfiguration().getVersion().toString();v=c.createFromFileContent(g,f);o.defaultVariants.push(v);o.byId[v.getId()]=v;v.addRevertInfo(new p({type:M.operationType.NewChange}))}else{v.addRevertInfo(new p({type:M.operationType.ContentUpdate,content:{previousState:v.getState(),previousContent:v.getContent()}}));v.setContent(t)}return v};M.revertSetDefaultVariantId=function(e){var t=l.getCompVariantsMap(e.reference)._getOrCreate(e.persistencyKey);var n=t.defaultVariants;var a=n[n.length-1];var r=a.popLatestRevertInfo();if(r.getType()===M.operationType.ContentUpdate){a.setContent(r.getContent().previousContent);a.setState(r.getContent().previousState)}else{a.setState(u.LifecycleState.DELETED);t.defaultVariants.pop()}};M.addVariant=function(t){if(!t){return undefined}var n=t.changeSpecificData;n.layer=F(n);n.changeType=n.type;n.texts=I(n);var a=Object.assign({},n,e(t,"changeSpecificData"));var r=c.createCompVariant(a);var i=l.getCompVariantsMap(t.reference);var o=i._getOrCreate(t.persistencyKey);o.variants.push(r);o.byId[r.getId()]=r;return r};M.updateVariant=function(e){function n(t,n){var a=t.getLayer()===n;var r=t.getFlexObjectMetadata().packageName;var i=!r||r==="$TMP";var o=t.getChanges().some(function(e){return e.getLayer()===n});return t.getPersisted()&&a&&i&&!o&&S(t,e)}function a(t){return t.getChanges().reverse().find(function(t){return t.getChangeType()==="updateVariant"&&V(t,e)})}function r(e,t,n,a){var r={type:n,change:a,content:{previousState:t.getState(),previousContent:t.getContent(),previousFavorite:t.getFavorite(),previousExecuteOnSelection:t.getExecuteOnSelection(),previousContexts:t.getContexts(),previousName:t.getName(),previousAction:e.action}};t.addRevertData(new s(r))}function i(e,t){r(e,t,M.operationType.ContentUpdate);if(e.executeOnSelection!==undefined){t.storeExecuteOnSelection(e.executeOnSelection)}if(e.favorite!==undefined){t.storeFavorite(e.favorite)}if(e.contexts){t.storeContexts(e.contexts)}if(e.name){t.storeName(e.name)}if(e.transportId){t.setRequest(e.transportId)}t.storeContent(e.content||t.getContent())}function o(e,n,a){var i=a.getRevertData()||[];var o=Object.assign({},a.getContent());var s={previousContent:Object.assign({},o),previousState:a.getState(),change:t(Object.assign({},e),["favorite","executeOnSelection","contexts","content","name"])};i.push(s);a.setRevertData(i);if(e.executeOnSelection!==undefined){o.executeOnSelection=e.executeOnSelection}if(e.favorite!==undefined){o.favorite=e.favorite}if(e.contexts){o.contexts=e.contexts}if(e.content){o.variantContent=e.content}if(e.name){a.setText("variantName",e.name)}a.setContent(o);if(e.transportId){a.setRequest(e.transportId)}r(e,n,M.operationType.UpdateVariantViaChangeUpdate,a);v.applyChangeOnVariant(n,a)}function p(e,t){function n(t){var n=l.getCompVariantsMap(e.reference);var a=t.getSelector().persistencyKey;n[a].changes.push(t);n[a].byId[t.getId()]=t}var a={};["favorite","executeOnSelection","contexts"].forEach(function(t){if(e[t]!==undefined){a[t]=e[t]}});if(e.content!==undefined){a.variantContent=e.content}var i=c.createUIChange({changeType:"updateVariant",layer:f,fileType:"change",reference:e.reference,packageName:e.packageName,content:a,selector:{persistencyKey:e.persistencyKey,variantId:t.getVariantId()}});if(e.name){i.setText("variantName",e.name,"XFLD",true)}if(e.transportId){i.setRequest(e.transportId)}n(i);r(e,t,M.operationType.NewChange,i);v.applyChangeOnVariant(t,i)}var u=U(e);var f=F(e);if(n(u,f)){i(e,u)}else{var g=a(u);if(g){o(e,u,g)}else{p(e,u)}}return u};M.discardVariantContent=function(e){var t=U(e);var n=t.getRevertData();if(n.length!==0){var a=n.slice().reverse().some(function(t){if(t.getContent().previousAction===M.updateActionType.SAVE){e.content=t.getContent().previousContent;e.action=M.updateActionType.DISCARD;return true}});if(!a){e.content=n[0].getContent().previousContent;e.action=M.updateActionType.DISCARD}M.updateVariant(e)}return t};M.updateActionType={UPDATE:"update",SAVE:"save",DISCARD:"discard",UPDATE_METADATA:"update_metadata"};M.operationType={StateUpdate:"StateUpdate",ContentUpdate:"ContentUpdate",NewChange:"NewChange",UpdateVariantViaChange:"UpdateVariantViaChange",UpdateVariantViaChangeUpdate:"UpdateVariantViaChangeUpdate"};M.removeVariant=function(e){var t=U(e);var n=t.getState();if(!e.revert){var a=new s({type:M.operationType.StateUpdate,content:{previousState:n}});t.addRevertData(a)}if(n===u.LifecycleState.NEW){var r=l.getCompVariantsMap(e.reference);var i=r._getOrCreate(e.persistencyKey);b(t,i);return t}t.markForDeletion();return t};M.revert=function(e){function n(t){var n=t.getSelector().persistencyKey;var a=l.getCompVariantsMap(e.reference);delete a[n].byId[t.getId()];a[n].changes=a[n].changes.filter(function(e){return e!==t})}var a=U(e);var r=a.getRevertData().pop();a.removeRevertData(r);var i=r.getContent();var o;switch(r.getType()){case M.operationType.ContentUpdate:L(a,Object.assign({name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts},t(e,["reference","persistencyKey","id"])));break;case M.operationType.NewChange:o=r.getChange();a.removeChange(o);n(o);j(a,Object.assign({name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts},t(e,["reference","persistencyKey","id"])));break;case M.operationType.UpdateVariantViaChangeUpdate:o=r.getChange();j(a,Object.assign({name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts},t(e,["reference","persistencyKey","id"])));var s=o.getRevertData().pop();o.setContent(s.previousContent);o.setState(s.previousState);break;case M.operationType.StateUpdate:default:break}a.setState(i.previousState);return a};M.overrideStandardVariant=function(e){var t=l.getCompVariantsMap(e.reference)[e.persistencyKey];var n=t.byId[t.standardVariant.getVariantId()];n.setExecuteOnSelection(!!e.executeOnSelection);var a=n.getChanges();n.removeAllChanges();a.forEach(function(e){v.applyChangeOnVariant(n,e)})};M.persist=function(e){function t(e,t,n){return d.write({flexObjects:[e.convertToFileContent?e.convertToFileContent():e.getDefinition()],layer:e.getLayer(),transport:e.getRequest(),isLegacyVariant:e.isVariant&&e.isVariant(),parentVersion:n}).then(function(t){if(t&&t.response&&t.response[0]){e.setResponse(t.response[0]);if(n){y.onAllChangesSaved({reference:t.response[0].reference,layer:t.response[0].layer})}}else{e.setState(u.LifecycleState.PERSISTED)}}).then(function(){var n=e.convertToFileContent?e.convertToFileContent():e.getDefinition();m(t.changes.comp,e).push(n);return n})}function n(e,n,a,r){switch(e.getState()){case u.LifecycleState.NEW:N(e);return t(e,a,r);case u.LifecycleState.DIRTY:N(e);return O(e,a,r);case u.LifecycleState.DELETED:N(e);return D(e,n,a,r);default:break}}var a=e.reference;var r=e.persistencyKey;var i=l.getCompVariantsMap(a);var o=i._getOrCreate(r);return l.getStorageResponse(a).then(function(e){var t=R(o).filter(E);var a=t.map(function(a,r){if(r===0){var i=h("/persistedVersion",{layer:a.getLayer(),reference:a.getFlexObjectMetadata?a.getFlexObjectMetadata().reference:a.getDefinition().reference});return n(a,o,e,i).then(function(){var a=t.map(function(t,a){if(a!==0){var r=i?C.Number.Draft:undefined;return n(t,o,e,r)}});return a})}});return Promise.all(a)})};M.persistAll=function(t){var n=e(l.getCompVariantsMap(t),"_getOrCreate","_initialize");var a=Object.keys(n).map(function(e){return M.persist({reference:t,persistencyKey:e})});return Promise.all(a)};M.hasDirtyChanges=function(e){var t=l.getCompVariantsMap(e);var n=[];for(var a in t){var r=t[a];for(var i in r.byId){n.push(r.byId[i])}}return n.some(function(e){return e.getState()!==u.LifecycleState.PERSISTED&&!(e.getVariantId&&e.getVariantId()==="*standard*")})};return M});