/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_union","sap/base/util/includes","sap/base/util/merge","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObject","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/Version","sap/ui/fl/Cache","sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement"],function(e,t,n,a,r,i,s,o,h,c,l,g,p,f,u,d,C,m,y,_,v,S,D,b,I,L){"use strict";var E=function(e){this._mComponent=e;this._mChanges=p.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=n({},this._mChanges);if(!this._mComponent||!this._mComponent.name){r.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.")}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist"};function M(e,t){var n;if(t instanceof c){n=t;this._mChangesEntries[n.getId()]=n}else{if(!this._mChangesEntries[t.fileName]){this._mChangesEntries[t.fileName]=l.createFromFileContent(t)}n=this._mChangesEntries[t.fileName];n.setState(g.LifecycleState.PERSISTED)}return n}E.prototype.getComponentName=function(){return this._mComponent.name};E.prototype.getCacheKey=function(e){return v.getCacheKey(this._mComponent,e)};function F(e){var t;var n;var a;var r;if(e instanceof c){var i=e;t=i.getFileType();a=i.getVariantReference();r=i.getSelector()&&i.getSelector().id}else{var s=e;t=s.fileType;n=s.variantManagementReference;a=s.variantReference;r=s.selector&&s.selector.id}var o=false;if(t==="ctrl_variant"||t==="ctrl_variant_change"||t==="ctrl_variant_management_change"){o=n||a||r}return t==="change"||o}E.prototype.getChangesForComponent=function(e,t){return b.getUShellService("URLParsing").then(function(n){this._oUShellURLParsingService=n;return v.getChangesFillingCache(this._mComponent,e,t)}.bind(this)).then(function(e,t){var a=n({},t);var r=e&&e.component&&b.getAppComponentForControl(e.component);var i=d.isStorageResponseFilled(a.changes);if(!i){return[]}var s=a.changes.changes;if(!this._oMessagebundle&&a.messagebundle&&r){if(!r.getModel("i18nFlexVendor")){if(s.some(function(e){return e.layer===D.VENDOR})){this._oMessagebundle=a.messagebundle;var o=new I(this._oMessagebundle);r.setModel(o,"i18nFlexVendor")}}}var h=e&&e.currentLayer;var c=!(e&&e.ignoreMaxLayerParameter);var l=function(){return true};if(h){s=S.filterChangeOrChangeDefinitionsByCurrentLayer(s,h)}else if(S.isLayerFilteringRequired(this._oUShellURLParsingService)&&c){l=O.bind(this);s=s.filter(l)}else if(this._bHasChangesOverMaxLayer&&!c){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST}var g=a.changes&&e&&e.includeCtrlVariants;var p=this._getAllCtrlVariantChanges(a,g,l);s=s.concat(p);return this._checkAndGetChangeInstances(s,a)}.bind(this,e))};E.prototype._checkAndGetChangeInstances=function(e,t){return e.filter(F).map(M.bind(this,t))};function O(e){if(S.isOverMaxLayer(x(e),this._oUShellURLParsingService)){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true}return false}return true}function x(e){var t;if(typeof e.isA==="function"&&(e.isA("sap.ui.fl.apply._internal.flexObjects.FlVariant")||e.isA("sap.ui.fl.apply._internal.flexObjects.UIChange"))){t=e.getLayer()}else{t=e.layer}return t}E.prototype._getAllCtrlVariantChanges=function(e,t,n){if(!t){return f.getInitialChanges({reference:this._mComponent.name})}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(t,n){if(e.changes[n]){return t.concat(e.changes[n])}return t},[]).filter(n)};E.prototype.loadChangesMapForComponent=function(e){return this.getChangesForComponent({component:e}).then(t.bind(this));function t(t){L.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=p.createEmptyDependencyMap();t.forEach(this.addChangeAndUpdateDependencies.bind(this,e));this._mChangesInitial=n({},this._mChanges);L.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this)}};E.prototype.getOpenDependentChangesForControl=function(e,t){return p.getOpenDependentChangesForControl(this._mChanges,i.getControlIdBySelector(e,t),t)};function A(e){var t=n({},this._mChangesInitial.mDependencies);return t[e.getId()]}function U(e,n,a,r){var s;var o=[];e.controlsDependencies.forEach(function(e){if(!i.bySelector(e,a)){s=i.getControlIdBySelector(e,a);o.push(e);this._mChanges.mControlsWithDependencies[s]=this._mChanges.mControlsWithDependencies[s]||[];if(!t(this._mChanges.mControlsWithDependencies[s],r.getId())){this._mChanges.mControlsWithDependencies[s].push(r.getId())}}}.bind(this));e.dependencies=n;e.controlsDependencies=o;if(n.length||o.length){this._mChanges.mDependencies[r.getId()]=e}}E.prototype.copyDependenciesFromInitialChangesMapSync=function(e,t,n){var a=A.call(this,e);if(a){var r=[];a.dependencies.forEach(function(n){if(t(n)){this._mChanges.mDependentChangesOnMe[n]=this._mChanges.mDependentChangesOnMe[n]||[];this._mChanges.mDependentChangesOnMe[n].push(e.getId());r.push(n)}}.bind(this));U.call(this,a,r,n,e)}return this._mChanges};E.prototype.copyDependenciesFromInitialChangesMap=function(e,t,n){var a=A.call(this,e);if(a){var r=[];return a.dependencies.reduce(function(n,a){return n.then(function(){return t(a)}).then(function(t){if(t){this._mChanges.mDependentChangesOnMe[a]=this._mChanges.mDependentChangesOnMe[a]||[];this._mChanges.mDependentChangesOnMe[a].push(e.getId());r.push(a)}}.bind(this))}.bind(this),Promise.resolve()).then(function(){U.call(this,a,r,n,e);return this._mChanges}.bind(this))}return Promise.resolve(this._mChanges)};E.prototype.addChangeAndUpdateDependencies=function(e,t,n){t.setInitialApplyState();if(n){p.insertChange(t,this._mChanges,n)}p.addChangeAndUpdateDependencies(t,e,this._mChanges)};E.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(e,t){p.addRuntimeChangeAndUpdateDependencies(t,e,this._mChanges,this._mChangesInitial)};E.prototype.getChangesMapForComponent=function(){return this._mChanges};E.prototype.getAllUIChanges=function(t){var n=e(this.getChangesMapForComponent().aChanges,t.includeDirtyChanges&&this.getDirtyChanges()).filter(function(e){return Boolean(e)&&e.getFileType()==="change"&&S.compareAgainstCurrentLayer(e.getLayer(),t.layer)===0});return n};E.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated};E.prototype.getChangesForView=function(e){return this.getChangesForComponent(e).then(function(t){return t.filter(h.filterChangeByView.bind(undefined,e))})};E.prototype.addChange=function(e,t){var n=this.addDirtyChange(e);this._addRunTimeCreatedChangeAndUpdateDependencies(t,n);this._mChangesEntries[n.getId()]=n;this._addPropagationListener(t);return n};E.prototype.addDirtyChange=function(e){var t;if(typeof e.isA==="function"&&e.isA("sap.ui.fl.apply._internal.flexObjects.FlexObject")){t=e}else{t=l.createFromFileContent(e)}if(this._aDirtyChanges.indexOf(t)===-1){this._aDirtyChanges.push(t)}return t};E.prototype._addPropagationListener=function(e){var t=b.getAppComponentForControl(e);if(t instanceof s){var n=function(e){return!e._bIsSapUiFlFlexControllerApplyChangesOnControl};var a=t.getPropagationListeners().every(n);if(a){var r=sap.ui.require("sap/ui/fl/FlexControllerFactory");var i=r.create(this.getComponentName());var h=o.applyAllChangesForControl.bind(o,this.getChangesMapForComponent.bind(this),t,i);h._bIsSapUiFlFlexControllerApplyChangesOnControl=true;t.addPropagationListener(h)}}};E.prototype._deleteNotSavedChanges=function(e,t,n){e.filter(function(e){return!t.some(function(t){return e.getId()===t.getId()})}).forEach(function(e){if(n){this.removeChange(e);v.deleteChange(this._mComponent,e.convertToFileContent())}else{this.deleteChange(e)}}.bind(this))};function R(e,t){var n=e.map(function(e){return e[t]()});var a=n.filter(function(e,t,n){return n.indexOf(e)===t});return a.length===1}function T(e,t,n){var r=false;if(!e||t.length<2||!R(t,"getLayer")){return false}if(n){r=true}else{var i=t[0].getLayer();if([D.CUSTOMER,D.USER].includes(i)){r=true}}var s=a.fromURL(window.location.href);if(s.has("sap-ui-xx-condense-changes")){r=s.get("sap-ui-xx-condense-changes")==="true"}return r}function P(e){var t=C.getInstanceOrUndef()&&C.getInstanceOrUndef().isCondensingEnabled();if(t&&!R(e,"getNamespace")){t=false}return t}function V(e,t,n,a){this._massUpdateCacheAndDirtyState(t,n);this._deleteNotSavedChanges(e,t,a)}function N(e,t,n,a){if(!e.length&&!n){return[]}var r=this._mChanges.aChanges.filter(function(e){if(a===D.CUSTOMER&&t){return e.getState()===g.LifecycleState.PERSISTED&&t.includes(e.getId())}return e.getState()===g.LifecycleState.PERSISTED&&S.compareAgainstCurrentLayer(e.getLayer(),a)===0});return r.concat(e)}function w(e){if(e.length){var t=H(e);var n=q(e);return n.length===1&&t.length===1&&n[0]===g.LifecycleState.NEW}return true}E.prototype.saveDirtyChanges=function(e,t,n,a,r,i,s){var o=n||this._aDirtyChanges;var h=o.length&&o[0].getLayer()||s;var c=N.call(this,o,r,i,h);var l=P(c)&&T(e,c,i);var g=l?c:o;var p=g.slice(0);var f=H(o);if(w(o)){var u=Promise.resolve(p);if(T(e,p,i)){u=m.condense(e,p)}return u.then(function(e){var n=f[0];if(l){return y.condense({allChanges:g,condensedChanges:e,layer:h,transport:n,isLegacyVariant:false,parentVersion:a}).then(function(n){V.call(this,g,e,t,true);return n}.bind(this))}if(e.length){return y.write({layer:h,flexObjects:B(e),transport:n,isLegacyVariant:false,parentVersion:a}).then(function(n){V.call(this,g,e,t);return n}.bind(this))}this._deleteNotSavedChanges(g,e)}.bind(this))}return this.saveSequenceOfDirtyChanges(o,t,a)};E.prototype.saveSequenceOfDirtyChanges=function(e,t,n){var a;if(n){var r=e.filter(function(e){return e.getState()===g.LifecycleState.NEW});a=[].concat(r).shift()}return e.reduce(function(e,r){return e.then(j.bind(undefined,r,a,n)).then(this._updateCacheAndDirtyState.bind(this,r,t))}.bind(this),Promise.resolve())};function j(e,t,n){switch(e.getState()){case g.LifecycleState.NEW:if(n!==undefined){n=e===t?n:_.Number.Draft}return y.write({layer:e.getLayer(),flexObjects:[e.convertToFileContent()],transport:e.getRequest(),parentVersion:n});case g.LifecycleState.DELETED:return y.remove({flexObject:e.convertToFileContent(),layer:e.getLayer(),transport:e.getRequest(),parentVersion:n});default:}}E.prototype._updateCacheAndDirtyState=function(e,t){this._aDirtyChanges=this._aDirtyChanges.filter(function(t){return e.getId()!==t.getId()});if(!t){if(b.isChangeRelatedToVariants(e)){f.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:e})}else{switch(e.getState()){case g.LifecycleState.NEW:e.setState(g.LifecycleState.PERSISTED);v.addChange(this._mComponent,e.convertToFileContent());break;case g.LifecycleState.DELETED:v.deleteChange(this._mComponent,e.convertToFileContent());break;case g.LifecycleState.DIRTY:e.setState(g.LifecycleState.PERSISTED);v.updateChange(this._mComponent,e.convertToFileContent());break}}}};E.prototype._massUpdateCacheAndDirtyState=function(e,t){e.forEach(function(e){this._updateCacheAndDirtyState(e,t)},this)};function H(e){var t=[];e.forEach(function(e){var n=e.getRequest();if(t.indexOf(n)===-1){t.push(n)}});return t}function q(e){var t=[];e.forEach(function(e){var n=e.getState();if(t.indexOf(n)===-1){t.push(n)}});return t}function B(e){var t=[];e.forEach(function(e){t.push(e.convertToFileContent())});return t}E.prototype.getDirtyChanges=function(){return this._aDirtyChanges};E.prototype.deleteChange=function(e,t){var n=this._aDirtyChanges.indexOf(e);if(n>-1){if(e.getState()===g.LifecycleState.DELETED){return}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(e,t);return}e.markForDeletion();this.addDirtyChange(e);this._deleteChangeInMap(e,t)};E.prototype.removeChange=function(e){var t=this._aDirtyChanges.indexOf(e);if(t>-1){this._aDirtyChanges.splice(t,1)}this._deleteChangeInMap(e)};E.prototype._deleteChangeInMap=function(e,t){var n=e.getId();p.removeChangeFromMap(this._mChanges,n);p.removeChangeFromDependencies(t?this._mChangesInitial:this._mChanges,n)};function W(e,t){return(t.getRequest()==="$TMP"||t.getRequest()==="")&&t.getLayer()===e}function k(e,t){return t.getState()===g.LifecycleState.PERSISTED&&t.getLayer()===e}function G(){var e=[];var t=u.getCompVariantsMap(this.getComponentName());for(var n in t){for(var a in t[n].byId){e.push(t[n].byId[a])}}return e}E.prototype.transportAllUIChanges=function(e,t,n,a){return this.getChangesForComponent({currentLayer:n,includeCtrlVariants:true}).then(function(r){var i=G.call(this);r=r.concat(i.filter(W.bind(this,n)));return y.publish({transportDialogSettings:{rootControl:e,styleClass:t},layer:n,reference:this.getComponentName(),localChanges:r,appVariantDescriptors:a})}.bind(this))};E.prototype._getChangesFromMapByNames=function(e){return this._mChanges.aChanges.filter(function(t){return e.indexOf(t.getId())!==-1})};E.prototype.removeDirtyChanges=function(e,t,n,a,r){var s=[].concat(e||[]);var o=this._aDirtyChanges;var h=o.filter(function(e){var o=true;if(s.length&&!s.includes(e.getLayer())){return false}if(a&&e.getSupportInformation().generator!==a){return false}if(n){var h=e.getSelector();o=n.getId()===i.getControlIdBySelector(h,t)}if(r){o=o&&r.indexOf(e.getChangeType())!==-1}return o});h.forEach(function(e){var t=o.indexOf(e);o.splice(t,1)});return Promise.resolve(h)};E.prototype.resetChanges=function(e,t,n,a){var r=n&&n.length>0;var i=a&&a.length>0;var s=C.getInstanceOrUndef()&&C.getInstanceOrUndef().isPublicLayerAvailable();var o=t===undefined&&n===undefined&&a===undefined;var h=[];if(s&&o){h=G.call(this).filter(k.bind(this,e))}return this.getChangesForComponent({currentLayer:e,includeCtrlVariants:true}).then(function(s){s=s.concat(h);var o={reference:this.getComponentName(),layer:e,changes:s};if(t){o.generator=t}if(r){o.selectorIds=n}if(i){o.changeTypes=a}return y.reset(o)}.bind(this)).then(function(e){var t=[];if(n||a){var r=[];if(e&&e.response&&e.response.length>0){e.response.forEach(function(e){r.push(e.fileName)})}v.removeChanges(this._mComponent,r);t=this._getChangesFromMapByNames(r)}return t}.bind(this))};return E});