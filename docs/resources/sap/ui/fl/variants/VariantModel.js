/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_isEqual","sap/base/util/each","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/core/Core","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/controlVariants/Switcher","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/registry/Settings","sap/ui/model/json/JSONModel"],function(e,t,n,a,r,i,o,s,c,l,f,h,u,p,g,v,d,m,V,C,R,y,x){"use strict";var D={};function F(e,t){return M(function(e,t){var n=t.model;var a=t.vmReference;var r=false;var i=e.key;var s=e.key;return Promise.resolve().then(function(){if(o.get([a,"currentVariant"],n.oData)&&n.oData[a].currentVariant!==n.oData[a].originalCurrentVariant){s=n.oData[a].originalCurrentVariant;r=true;return n.updateCurrentVariant({variantManagementReference:a,newVariantReference:i,appComponent:n.oAppComponent,internallyCalled:true})}}).then(function(){if(o.get([a,"modified"],n.oData)===true){var e=d.getControlChangesForVariant({reference:n.sFlexReference,vmReference:a,vReference:s});return b({changes:e,vmReference:a,vReference:s,revert:!r,model:n}).then(function(){n.oData[a].originalCurrentVariant=i;n.oData[a].modified=false;n.checkUpdate(true)})}}).then(function(){if(!r){n.callVariantSwitchListeners(a,n.oData[a].currentVariant)}})}.bind(null,e.getParameters(),t),t.model,t.vmReference)}function S(e,t,n){if(n||e.oData[t]){e.oData[t].variantBusy=n}e.checkUpdate()}function b(e){var t=e.model._getDirtyChangesFromVariantChanges(e.changes);t=t.reverse();return Promise.resolve().then(function(){if(e.revert){return h.revertMultipleChanges(t,{appComponent:e.model.oAppComponent,modifier:c,flexController:e.model.oFlexController})}return undefined}).then(function(){t.forEach(function(t){d.removeChangeFromVariant({reference:e.model.sFlexReference,change:t,vmReference:e.vmReference,vReference:e.vReference});e.model.oFlexController.deleteChange(t,e.model.oAppComponent)})})}function M(e,t,n){t._oVariantSwitchPromise=t._oVariantSwitchPromise.catch(function(){}).then(S.bind(null,t,n,true)).then(e).then(S.bind(null,t,n,false)).catch(function(e){S(t,n,false);throw e});t.oFlexController.setVariantSwitchPromise(t._oVariantSwitchPromise);return t._oVariantSwitchPromise}function E(e,t){D[e]=t}function I(e,t){return v.switchVariant(e).then(function(){this.oData[e.vmReference].originalCurrentVariant=e.newVReference;this.oData[e.vmReference].currentVariant=e.newVReference;if(this.oData[e.vmReference].updateVariantInURL){u.updateVariantInURL({vmReference:e.vmReference,newVReference:e.newVReference,model:this})}this.checkUpdate();this.callVariantSwitchListeners(e.vmReference,e.newVReference,undefined,t)}.bind(this))}function T(e){y.getInstance().then(function(t){if(!t.isVariantPersonalizationEnabled()){e.remove=false;e.rename=false;e.change=false}})}function _(e,t,n){var a=n?C.getCurrentLayer():V.USER;if(e.layer===a&&e.key!==t){return true}return false}function P(e){return new Promise(function(t){if(e.getDomRef()){t()}else{e.addEventDelegate({onAfterRendering:function(){t()}})}})}var U=x.extend("sap.ui.fl.variants.VariantModel",{constructor:function(e,t){this.pSequentialImportCompleted=Promise.resolve();x.apply(this,[e]);this.sharing={PRIVATE:"private",PUBLIC:"public"};this.oFlexController=t.flexController;this.oChangePersistence=this.oFlexController._oChangePersistence;this.sFlexReference=this.oChangePersistence.getComponentName();this.oAppComponent=t.appComponent;this._oResourceBundle=f.getLibraryResourceBundle("sap.ui.fl");this._oVariantSwitchPromise=Promise.resolve();this._oVariantAppliedListeners={};if(r(e)){try{e=d.fillVariantModel({reference:this.sFlexReference})}catch(e){s.error("Variants Map was not found: "+e.message)}}if(e&&typeof e==="object"){Object.keys(e).forEach(function(t){e[t].variants.forEach(function(n){if(!e[t].currentVariant&&n.key===e[t].defaultVariant){e[t].currentVariant=n.key}n.originalTitle=n.title;n.originalFavorite=n.favorite;n.originalExecuteOnSelect=n.executeOnSelect;n.originalVisible=n.visible;n.originalContexts=n.contexts});e[t].originalCurrentVariant=e[t].currentVariant;e[t].originalDefaultVariant=e[t].defaultVariant});this.setData(e)}d.addUpdateStateListener(this.sFlexReference,A.bind(this))}});function A(){this.checkDirtyStateForControlModels(Object.keys(this.oData||{}))}U.prototype.initialize=function(){return Promise.resolve().then(function(){var e=R.getUshellContainer();if(e){var t=[R.getUShellService("UserInfo"),R.getUShellService("URLParsing"),R.getUShellService("CrossApplicationNavigation"),R.getUShellService("ShellNavigation")];return Promise.all(t).then(function(e){E("UserInfo",e[0]);E("URLParsing",e[1]);E("CrossApplicationNavigation",e[2]);E("ShellNavigation",e[3])}).catch(function(e){throw new Error("Error getting service from Unified Shell: "+e)})}return undefined}).then(function(){u.initialize({model:this})}.bind(this))};U.prototype.updateCurrentVariant=function(e){var t={vmReference:e.variantManagementReference,currentVReference:this.oData[e.variantManagementReference].originalCurrentVariant,newVReference:e.newVariantReference,flexController:this.oFlexController,appComponent:e.appComponent||this.oAppComponent,modifier:c,reference:this.sFlexReference};if(e.internallyCalled){return I.call(this,t,e.scenario)}return M(I.bind(this,t,e.scenario),this,e.variantManagementReference)};U.prototype.getCurrentVariantReference=function(e){return this.oData[e].currentVariant};U.prototype.getVariantManagementReference=function(e){var t="";var n=-1;Object.keys(this.oData).some(function(a){return this.oData[a].variants.some(function(r,i){if(r.key===e){t=a;n=i;return true}})}.bind(this));return{variantManagementReference:t,variantIndex:n}};U.prototype.getVariant=function(e,t){return d.getVariant({reference:this.sFlexReference,vmReference:t||this.getVariantManagementReference(e).variantManagementReference,vReference:e})};U.prototype.getVariantTitle=function(e,t){var n="";this.oData[t].variants.some(function(t){if(t.key===e){n=t.title;return true}});return n};function O(e,t){var n=d.getVariantChangesForVariant({vmReference:e,reference:this.sFlexReference});var a=this.oData[e].currentVariant;var r=this.oData[e].defaultVariant;if(t.getExecuteOnSelectionForStandardDefault()&&a===r&&a===e&&!n.setExecuteOnSelect){var i=d.getVariant({reference:this.sFlexReference,vmReference:e,vReference:e});i.instance.setExecuteOnSelection(true);this.oData[e].variants[0].originalExecuteOnSelect=true;this.oData[e].variants[0].executeOnSelect=true;return true}return false}U.prototype.attachVariantApplied=function(e){var t=f.byId(e.vmControlId);var n=this.getVariantManagementReferenceForControl(t);return this.waitForVMControlInit(n).then(function(e,n){if(!this._oVariantAppliedListeners[e]){this._oVariantAppliedListeners[e]={}}var a=O.call(this,e,t);if(n.callAfterInitialVariant||a){var r={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:e,flexController:this.oFlexController};d.waitForInitialVariantChanges(r).then(function(){var t=d.getCurrentVariantReference({vmReference:e,reference:this.sFlexReference});this.callVariantSwitchListeners(e,t,n.callback)}.bind(this))}return P(n.control).then(function(){if(m.getRelevantVariantManagementControlId(n.control,this.getVariantManagementControlIds())===n.vmControlId){this.oData[e].showExecuteOnSelection=true;this.checkUpdate(true);this._oVariantAppliedListeners[e][n.control.getId()]=n.callback}else{s.error("Error in attachVariantApplied: The passed VariantManagement ID does not match the responsible VariantManagement control")}}.bind(this))}.bind(this,n,e))};U.prototype.callVariantSwitchListeners=function(e,t,a,r){if(this._oVariantAppliedListeners[e]){var o;this.oData[e].variants.some(function(e){if(e.key===t){o=i({},e);return true}});if(r){o.createScenario=r}if(a){a(o)}else{n(this._oVariantAppliedListeners[e],function(e,t){t(o)})}}};U.prototype.detachVariantApplied=function(e,t){var n=this.getVariantManagementReferenceForControl(f.byId(e));if(this._oVariantAppliedListeners[n]){delete this._oVariantAppliedListeners[n][t]}};U.prototype.addChange=function(e){var t=e.getVariantReference();var n=this.getVariantManagementReference(t).variantManagementReference;if(e.getState()===g.LifecycleState.NEW){this.oData[n].modified=true}this.checkUpdate(true);return d.addChangeToVariant({reference:this.sFlexReference,change:e,vmReference:n,vReference:t})};U.prototype.removeChange=function(e){var t=e.getVariantReference();var n=this.getVariantManagementReference(t).variantManagementReference;var a=d.removeChangeFromVariant({reference:this.sFlexReference,change:e,vmReference:n,vReference:t});this.checkDirtyStateForControlModels([n]);return a};U.prototype.eraseDirtyChangesOnVariant=function(e,t){var n=d.getControlChangesForVariant({reference:this.sFlexReference,vmReference:e,vReference:t});var a=this._getDirtyChangesFromVariantChanges(n);return b({changes:n,vmReference:e,vReference:t,model:this,revert:true}).then(function(){return a})};U.prototype.addAndApplyChangesOnVariant=function(e){return e.reduce(function(e,t){return e.then(function(){this.oFlexController.addPreparedChange(t,this.oAppComponent);var e=f.byId(c.getControlIdBySelector(t.getSelector(),this.oAppComponent));return this.oFlexController.applyChange(t,e)}.bind(this))}.bind(this),Promise.resolve())};U.prototype._getVariantTitleCount=function(e,t){var n=this.getData();return n[t].variants.reduce(function(t,n){if(e.toLowerCase()===n.title.toLowerCase()&&n.visible){t++}return t},0)};function k(e,t){var n={id:t.newVariantReference,variantName:t.title,contexts:t.contexts,layer:t.layer,reference:e.getFlexObjectMetadata().reference,generator:t.generator,variantManagementReference:t.variantManagementReference};if(t.currentVariantComparison===1){if(t.sourceVariantSource.instance.getLayer()===t.layer){n.variantReference=t.sourceVariantSource.instance.getVariantReference()}else{n.variantReference=e.getVariantReference()}}else if(t.currentVariantComparison===0){n.variantReference=e.getVariantReference()}else if(t.currentVariantComparison===-1){n.variantReference=t.sourceVariantReference}return p.createFlVariant(n)}U.prototype._duplicateVariant=function(e){var t=e.sourceVariantReference;var n=e.variantManagementReference;var a=this.getVariant(t);var r=d.getControlChangesForVariant({vmReference:n,vReference:t,reference:this.sFlexReference}).map(function(e){return e.convertToFileContent()});e.currentVariantComparison=C.compareAgainstCurrentLayer(a.instance.getLayer(),e.layer);if(e.currentVariantComparison===1){e.sourceVariantSource=this.getVariant(a.instance.getVariantReference())}var o={instance:k(a.instance,e),controlChanges:r,variantChanges:{}};r=o.controlChanges.slice();var s={};o.controlChanges=r.reduce(function(t,n){if(C.compareAgainstCurrentLayer(n.layer,e.layer)>=0){s=i({},n);s.layer=e.layer;s.variantReference=o.instance.getId();if(!s.support){s.support={}}s.support.sourceChangeFileName=n.fileName;s.packageName="$TMP";s.fileName=R.createDefaultFileName(s.changeType);t.push(p.createFromFileContent(s))}return t},[]);return o};U.prototype.copyVariant=function(e){var t=this._duplicateVariant(e);t.generator=e.generator;var n={key:t.instance.getId(),layer:e.layer,title:t.instance.getName(),originalTitle:t.instance.getName(),originalExecuteOnSelect:t.instance.getExecuteOnSelection(),executeOnSelect:false,favorite:true,originalFavorite:true,rename:true,change:true,remove:true,visible:true,originalVisible:true,sharing:e.layer===V.USER?this.sharing.PRIVATE:this.sharing.PUBLIC,originalContexts:t.instance.getContexts(),contexts:t.instance.getContexts()};var a=[];[t.instance].concat(t.controlChanges).forEach(function(e){a.push(this.oChangePersistence.addDirtyChange(e))}.bind(this));var r=d.addVariantToVariantManagement({variantData:t,reference:this.sFlexReference,vmReference:e.variantManagementReference});this.oData[e.variantManagementReference].variants.splice(r,0,n);return this.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:t.instance.getId(),appComponent:e.appComponent,internallyCalled:true,scenario:"saveAs"}).then(function(){return a})};U.prototype.removeVariant=function(e){var t=this.oChangePersistence.getDirtyChanges().filter(function(t){return t.getVariantReference&&t.getVariantReference()===e.variant.getId()||t.getId()===e.variant.getId()});return this.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:e.sourceVariantReference,appComponent:e.component}).then(function(){var n=d.removeVariantFromVariantManagement({reference:this.sFlexReference,variant:e.variant,vmReference:e.variantManagementReference});this.oData[e.variantManagementReference].variants.splice(n,1);this.checkUpdate();t.forEach(function(e){this.oChangePersistence.deleteChange(e)}.bind(this))}.bind(this))};U.prototype.collectModelChanges=function(e,n){var a=this.getData()[e];var r=a.variants;var i=[];var o={};r.forEach(function(e){if(e.originalTitle!==e.title){o={variantReference:e.key,changeType:"setTitle",title:e.title,originalTitle:e.originalTitle,layer:n};i.push(o)}if(e.originalFavorite!==e.favorite){o={variantReference:e.key,changeType:"setFavorite",favorite:e.favorite,originalFavorite:e.originalFavorite,layer:n};i.push(o)}if(e.originalExecuteOnSelect!==e.executeOnSelect){o={variantReference:e.key,changeType:"setExecuteOnSelect",executeOnSelect:e.executeOnSelect,originalExecuteOnSelect:e.originalExecuteOnSelect,layer:n};i.push(o)}if(!e.visible&&e.originalVisible){o={variantReference:e.key,changeType:"setVisible",visible:false,layer:n};i.push(o)}if(!t(e.originalContexts,e.contexts)){o={variantReference:e.key,changeType:"setContexts",layer:n,contexts:e.contexts,originalContexts:e.originalContexts};i.push(o)}});if(a.originalDefaultVariant!==a.defaultVariant){o={variantManagementReference:e,changeType:"setDefault",defaultVariant:a.defaultVariant,originalDefaultVariant:a.originalDefaultVariant,layer:n};i.push(o)}return i};U.prototype.manageVariants=function(e,t,n,a,r){return new Promise(function(i){e.attachEventOnce("manage",{resolve:i,variantManagementReference:t,layer:n},this.fnManageClickRta,this);e.openManagementDialog(true,a,r)}.bind(this))};U.prototype.addVariantChange=function(e,t){var n=this.setVariantProperties(e,t);var a={};var r={vmReference:e,add:true,reference:this.sFlexReference};a.changeType=t.changeType;a.layer=t.layer;a.generator=t.generator;if(t.changeType==="setDefault"){a.fileType="ctrl_variant_management_change";a.selector=c.getSelector(e,t.appComponent)}else{a.fileType="ctrl_variant_change";a.selector=c.getSelector(t.variantReference,t.appComponent)}var i=this.oFlexController.createBaseChange(a,t.appComponent);i.setContent(n);if(t.changeType==="setTitle"){i.setText("title",t.title,"XFLD")}r.changeContent=i.convertToFileContent();d.updateChangesForVariantManagementInMap(r);this.oChangePersistence.addDirtyChange(i);return i};U.prototype.deleteVariantChange=function(e,t,n){var a={vmReference:e,add:false,reference:this.sFlexReference,changeContent:undefined};this.setVariantProperties(e,t,true);a.changeContent=n.convertToFileContent();d.updateChangesForVariantManagementInMap(a);this.oChangePersistence.deleteChange(n)};U.prototype.setVariantProperties=function(e,t,n){var a=-1;var r;var i=this.getData();var o=this.getVariant(t.variantReference,e).instance;if(t.variantReference){a=this.getVariantManagementReference(t.variantReference).variantIndex;r=i[e].variants[a]}var s={};switch(t.changeType){case"setTitle":s.title=t.title;r.title=t.title;r.originalTitle=r.title;o.setName(t.title,true);break;case"setFavorite":s.favorite=t.favorite;r.favorite=t.favorite;r.originalFavorite=r.favorite;o.setFavorite(t.favorite);break;case"setExecuteOnSelect":s.executeOnSelect=t.executeOnSelect;r.executeOnSelect=t.executeOnSelect;r.originalExecuteOnSelect=r.executeOnSelect;o.setExecuteOnSelection(t.executeOnSelect);break;case"setVisible":s.visible=t.visible;s.createdByReset=false;r.visible=t.visible;r.originalVisible=r.visible;o.setVisible(t.visible);break;case"setContexts":s.contexts=t.contexts;r.contexts=t.contexts;r.originalContexts=t.contexts;o.setContexts(t.contexts);break;case"setDefault":s.defaultVariant=t.defaultVariant;i[e].defaultVariant=t.defaultVariant;i[e].originalDefaultVariant=i[e].defaultVariant;var c=u.getStoredHashParams({model:this});if(c){if(i[e].defaultVariant!==i[e].currentVariant&&c.indexOf(i[e].currentVariant)===-1){u.update({parameters:c.concat(i[e].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}else if(i[e].defaultVariant===i[e].currentVariant&&c.indexOf(i[e].currentVariant)>-1){c.splice(c.indexOf(i[e].currentVariant),1);u.update({parameters:c,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}}if(n&&i[e].currentVariant!==t.defaultVariant){this.updateCurrentVariant({variantManagementReference:e,newVariantReference:t.defaultVariant,appComponent:t.appComponent})}break;default:break}var l=d.getContent(this.sFlexReference);if(a>-1){var f=d.setVariantData({variantData:s,vmReference:e,previousIndex:a,reference:this.sFlexReference});i[e].variants.splice(a,1);i[e].variants.splice(f,0,r)}else if(l[e]){l[e].defaultVariant=t.defaultVariant}this.setData(i);this.checkUpdate(true);return s};U.prototype._ensureStandardVariantExists=function(t){var n=this.getData();var a=n[t]||{};var o=e(a,["initPromise"]);if(!n[t]||r(o)){n[t]=i(a,{currentVariant:t,originalCurrentVariant:t,defaultVariant:t,originalDefaultVariant:t,variants:[{key:t,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),originalTitle:this._oResourceBundle.getText("STANDARD_VARIANT_ORIGINAL_TITLE"),favorite:true,originalFavorite:true,executeOnSelect:false,originalExecuteOnSelect:false,visible:true,originalVisible:true,contexts:{},originalContexts:{},author:m.DEFAULT_AUTHOR}]});this.setData(n);var c={};c[t]={defaultVariant:t,variantManagementChanges:{},variants:[{instance:p.createFlVariant({id:t,variantManagementReference:t,variantName:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),user:m.DEFAULT_AUTHOR,reference:this.sFlexReference}),controlChanges:[],variantChanges:{}}]};try{d.addFakeStandardVariant(this.sFlexReference,this.oAppComponent.getId(),c)}catch(e){s.error("Variants Map was not found: "+e.message)}}};U.prototype.setModelPropertiesForControl=function(e,t,n){this.oData[e].modified=false;this.oData[e].showFavorites=true;var a=this._bDesignTimeMode;if(a!==t){this._bDesignTimeMode=t;if(t){u.clearAllVariantURLParameters({model:this})}else if(a){u.update({parameters:u.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this})}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents()}n.detachManage(this.fnManageClick,this);if(t&&this.oData[e]._isEditable){this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(n){n.rename=true;n.change=true;n.sharing=this.sharing.PUBLIC;n.remove=_(n,e,t)}.bind(this))}else if(this.oData[e]._isEditable){n.attachManage({variantManagementReference:e},this.fnManageClick,this);this.oData[e].variantsEditable=true;this.oData[e].variants.forEach(function(n){n.remove=_(n,e,t);switch(n.layer){case V.USER:n.rename=true;n.change=true;n.sharing=this.sharing.PRIVATE;T(n);break;case V.PUBLIC:var a=this._oUserInfoService&&this._oUserInfoService.getUser();var r=!a||a.getId().toUpperCase()===n.author.toUpperCase()||y.getInstanceOrUndef().isKeyUser();n.remove=r;n.rename=r;n.change=r;n.sharing=this.sharing.PUBLIC;break;default:n.rename=false;n.change=false;n.sharing=this.sharing.PUBLIC}}.bind(this))}else{this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(e){e.remove=false;e.rename=false;e.change=false})}};U.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(e,t){var n=this.collectModelChanges(t.variantManagementReference,t.layer);t.resolve(n)};this.fnManageClick=function(e,t){if(!this.oFlexController||!d.getContent(this.sFlexReference)){return}var n=this.collectModelChanges(t.variantManagementReference,V.USER);var a=[];n.forEach(function(e){e.appComponent=this.oAppComponent;a.push(this.addVariantChange(t.variantManagementReference,e))}.bind(this));this.oChangePersistence.saveDirtyChanges(this.oAppComponent,false,a)}};function L(e,t,n,a){if(!this._bDesignTimeMode){return e.saveSequenceOfDirtyChanges(t,a).then(function(e){if(e){var t=e.response[0];this.oData[n].variants.forEach(function(e){if(e.key===t.fileName){e.author=t.support.user}})}}.bind(this))}return Promise.resolve()}U.prototype._handleSaveEvent=function(e){if(!this._bDesignTimeMode){var t=e.getSource();var n=e.getParameters();return this._handleSave(t,n)}return Promise.resolve()};U.prototype._handleSave=function(e,t){var n=R.getAppComponentForControl(e);var a=this.getLocalId(e.getId(),n);var r;return M(function(e,t,n){var a=n.def;var i=n.execute;var o=this.getCurrentVariantReference(e);var s=d.getControlChangesForVariant({reference:this.sFlexReference,vmReference:e,vReference:o});if(n.overwrite){return this.oFlexController.saveSequenceOfDirtyChanges(this._getDirtyChangesFromVariantChanges(s),t)}var c=n.layer||(n.public?V.PUBLIC:V.USER);var l=n.layer||V.USER;var f=n.newVariantReference||R.createDefaultFileName("flVariant");var h={variantManagementReference:e,appComponent:t,layer:c,title:n.name,contexts:n.contexts,sourceVariantReference:o,newVariantReference:f,generator:n.generator};return this.copyVariant(h).then(function(n){if(a){var c={changeType:"setDefault",defaultVariant:f,originalDefaultVariant:this.oData[e].defaultVariant,appComponent:t,layer:l,variantManagementReference:e};var h=this.addVariantChange(e,c);n.push(h)}if(i){var u={changeType:"setExecuteOnSelect",executeOnSelect:true,variantReference:f,appComponent:t,layer:l,variantManagementReference:e};var p=this.addVariantChange(e,u);n.push(p)}r=n;return b({changes:s,vmReference:e,vReference:o,model:this}).then(L.bind(this,this.oFlexController,n,e,t))}.bind(this))}.bind(this,a,n,t),this,a).then(function(){this.oData[a].modified=false;this.checkUpdate(true);return r}.bind(this))};U.prototype.getLocalId=function(e,t){return c.getSelector(e,t).id};U.prototype.getVariantManagementReferenceForControl=function(e){var t=e.getId();var n=R.getAppComponentForControl(e);return n&&n.getLocalId(t)||t};U.prototype.switchToDefaultForVariantManagement=function(e){if(this.oData[e].currentVariant!==this.oData[e].defaultVariant){l.show(200);this.updateCurrentVariant({variantManagementReference:e,newVariantReference:this.oData[e].defaultVariant}).then(function(){l.hide()})}};U.prototype.switchToDefaultForVariant=function(e){Object.keys(this.oData).forEach(function(t){if(!e||this.oData[t].currentVariant===e){this.switchToDefaultForVariantManagement(t)}}.bind(this))};U.prototype.registerToModel=function(e){var t=this.getVariantManagementReferenceForControl(e);this._ensureStandardVariantExists(t);this.oData[t]._isEditable=e.getEditable();this.oData[t].showExecuteOnSelection=false;e.attachEvent("select",{vmReference:t,model:this},F);e.attachSave(this._handleSaveEvent,this);this.setModelPropertiesForControl(t,false,e);var n=e.getUpdateVariantInURL();this.oData[t].updateVariantInURL=n;u.registerControl({vmReference:t,updateURL:!!n,model:this});u.handleModelContextChange({model:this,vmControl:e});if(this.oData[t].initPromise){this.oData[t].initPromise.resolveFunction();delete this.oData[t].initPromise}this.oData[t].init=true;var a={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:t,flexController:this.oFlexController};this._oVariantSwitchPromise=this._oVariantSwitchPromise.then(d.waitForInitialVariantChanges.bind(undefined,a))};U.prototype.waitForVMControlInit=function(e){if(!this.oData[e]){this.oData[e]={}}else if(this.oData[e].init){return Promise.resolve()}this.oData[e].initPromise={};this.oData[e].initPromise.promise=new Promise(function(t){this.oData[e].initPromise.resolveFunction=t}.bind(this));return this.oData[e].initPromise.promise};U.prototype._getDirtyChangesFromVariantChanges=function(e){var t=e.map(function(e){return e.getId()});return this.oChangePersistence.getDirtyChanges().filter(function(e){return a(t,e.getId())&&!e.assignedToVariant})};U.prototype.checkDirtyStateForControlModels=function(e){e.forEach(function(e){var t=this.oData[e];var n=this.getCurrentVariantReference(e);var a=d.getControlChangesForVariant({reference:this.sFlexReference,vmReference:e,vReference:n});var r=this._getDirtyChangesFromVariantChanges(a);t.modified=r.length>0}.bind(this));this.checkUpdate(true)};U.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(e,t){return e.concat([this.oData[t].currentVariant])}.bind(this),[])};U.prototype.getVariantManagementControlIds=function(){var e;return Object.keys(this.oData||{}).reduce(function(t,n){if(this.oAppComponent.byId(n)){e=this.oAppComponent.createId(n)}else{e=n}t.push(e);return t}.bind(this),[])};U.prototype.destroy=function(){d.clearFakedStandardVariants(this.sFlexReference,this.oAppComponent.getId());d.removeUpdateStateListener(this.sFlexReference);x.prototype.destroy.apply(this)};U.prototype.getUShellService=function(e){return R.getUshellContainer()&&D[e]};return U});